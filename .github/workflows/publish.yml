name: Build Book

on:
  push:
    branches: [main]
    paths:
      - 'chapters/**'
      - 'leanpub/**'
      - 'assets/**'
      - 'examples/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub Release with the EPUB'
        required: false
        default: false
        type: boolean
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: false
        default: 'v0.1.0'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Build manuscript
        run: |
          chmod +x scripts/leanpub-build.sh
          ./scripts/leanpub-build.sh

      - name: Generate EPUB
        run: |
          pandoc \
            leanpub/frontmatter.md \
            leanpub/part1.md \
            leanpub/chapters/ch01-the-compound-systems-engineer.md \
            leanpub/chapters/ch02-getting-started-with-claude-code.md \
            leanpub/chapters/ch03-prompting-fundamentals.md \
            leanpub/part2.md \
            leanpub/chapters/ch04-writing-your-first-claude-md.md \
            leanpub/chapters/ch05-the-12-factor-agent.md \
            leanpub/chapters/ch06-the-verification-ladder.md \
            leanpub/part3.md \
            leanpub/chapters/ch07-quality-gates-that-compound.md \
            leanpub/chapters/ch08-error-handling-and-debugging.md \
            leanpub/chapters/ch09-context-engineering-deep-dive.md \
            leanpub/part4.md \
            leanpub/chapters/ch10-the-ralph-loop.md \
            leanpub/chapters/ch11-sub-agent-architecture.md \
            leanpub/chapters/ch12-development-workflows.md \
            leanpub/chapters/ch13-building-the-harness.md \
            leanpub/chapters/ch14-the-meta-engineer-playbook.md \
            leanpub/chapters/ch15-model-strategy-and-cost-optimization.md \
            leanpub/backmatter.md \
            --metadata title="The Meta-Engineer: 10x Was the Floor" \
            --metadata subtitle="Building Autonomous AI Systems with Claude Code" \
            --metadata author="James Phoenix" \
            --epub-cover-image=leanpub/images/cover.jpg \
            --css=leanpub/epub-style.css \
            --from markdown-yaml_metadata_block \
            --lua-filter=leanpub/filters/strip-md-links.lua \
            --syntax-highlighting=tango \
            --epub-embed-font=leanpub/fonts/JetBrainsMono-Regular.ttf \
            --epub-embed-font=leanpub/fonts/JetBrainsMono-Bold.ttf \
            --epub-embed-font=leanpub/fonts/JetBrainsMono-Italic.ttf \
            --epub-embed-font=leanpub/fonts/source-serif-4-latin-400-normal.woff2 \
            --epub-embed-font=leanpub/fonts/source-serif-4-latin-400-italic.woff2 \
            --epub-embed-font=leanpub/fonts/source-serif-4-latin-600-normal.woff2 \
            --epub-embed-font=leanpub/fonts/source-serif-4-latin-700-normal.woff2 \
            --epub-embed-font=leanpub/fonts/source-sans-3-latin-400-normal.woff2 \
            --epub-embed-font=leanpub/fonts/source-sans-3-latin-600-normal.woff2 \
            --epub-embed-font=leanpub/fonts/source-sans-3-latin-700-normal.woff2 \
            --toc \
            --toc-depth=2 \
            -o the-meta-engineer.epub

      - name: Build summary
        run: |
          WORDS=$(cat leanpub/chapters/*.md | wc -w)
          CHAPTERS=$(ls leanpub/chapters/*.md | wc -l)
          SIZE=$(du -h the-meta-engineer.epub | cut -f1)
          echo "### Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chapters | $CHAPTERS |" >> $GITHUB_STEP_SUMMARY
          echo "| Word Count | $WORDS |" >> $GITHUB_STEP_SUMMARY
          echo "| EPUB Size | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Upload EPUB artifact
        uses: actions/upload-artifact@v4
        with:
          name: the-meta-engineer-epub
          path: the-meta-engineer.epub

      - name: Create GitHub Release
        if: inputs.create_release == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: "The Meta-Engineer ${{ inputs.version }}"
          body: |
            ## The Meta-Engineer: 10x Was the Floor
            Building Autonomous AI Systems with Claude Code

            Download the EPUB below and upload to Leanpub or your preferred reader.
          files: the-meta-engineer.epub
          draft: false
